<UserControl x:Class="Mobius.Views.Controls.AppCard"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:Mobius.Converters"
             MinHeight="92">

    <UserControl.Resources>
        <conv:BoolToBrushConverter x:Key="CardBrush"
                                   TrueBrush="{StaticResource GreenBrush}"
                                   FalseBrush="{StaticResource PurpleCardBrush}"/>
        <conv:BoolToBrushConverter x:Key="SpeechDotBrush"
                                   TrueBrush="{StaticResource GreenBrush}"
                                   FalseBrush="{StaticResource RedBrush}"/>
    </UserControl.Resources>

    <Border Style="{StaticResource AppCardBorder}"
            Background="{Binding IsRunning, Converter={StaticResource CardBrush}}"
            Padding="12">

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="64"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Icon + settings button under icon -->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="64"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Border Width="52"
                        Height="52"
                        CornerRadius="14"
                        Background="{StaticResource BgSurface2Brush}"
                        VerticalAlignment="Top">
                    <Image Source="{Binding IconPath}" Stretch="UniformToFill"/>
                </Border>

                <Button Grid.Row="1"
                        Width="52"
                        Height="22"
                        Margin="0,6,0,0"
                        Background="{StaticResource GrayDarkBrush}"
                        Foreground="{StaticResource TextPrimaryBrush}"
                        BorderBrush="#00000000"
                        FontSize="12"
                        Content="⚙"
                        ToolTip="Настройки фраз"
                        Command="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=SettingsCommand}"
                        CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=SettingsCommandParameter}"/>
            </Grid>

            <!-- Text block -->
            <Grid Grid.Column="1" Margin="12,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Title (view + edit) -->
                <Grid Grid.Row="0">
                    <TextBlock x:Name="TitleText"
                               Text="{Binding Name}"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               FontSize="16"
                               FontWeight="SemiBold"
                               TextTrimming="CharacterEllipsis"
                               VerticalAlignment="Center"/>

                    <TextBox x:Name="TitleEdit"
                             Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Background="{StaticResource BgSurface2Brush}"
                             Foreground="{StaticResource TextPrimaryBrush}"
                             BorderBrush="#00000000"
                             FontSize="16"
                             FontWeight="SemiBold"
                             Padding="6,3"
                             Visibility="Collapsed"
                             VerticalAlignment="Center"
                             KeyDown="TitleEdit_KeyDown"
                             LostKeyboardFocus="TitleEdit_LostKeyboardFocus"/>
                </Grid>

                <TextBlock Grid.Row="1"
                           Text="{Binding SourceText}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           FontSize="12"
                           Margin="0,6,0,0"
                           TextTrimming="CharacterEllipsis"/>

                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,10,0,0">
                    <Ellipse Width="8"
                             Height="8"
                             Margin="0,0,8,2"
                             Fill="{Binding SpeechEnabled, Converter={StaticResource SpeechDotBrush}}"/>
                    <TextBlock Text="Распознание речи"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontSize="12"/>
                </StackPanel>
            </Grid>

            <TextBlock Grid.Column="2"
                       Text="›"
                       Foreground="{StaticResource TextSecondaryBrush}"
                       FontSize="22"
                       VerticalAlignment="Center"
                       Margin="10,0,4,0"/>
        </Grid>
    </Border>
</UserControl>
